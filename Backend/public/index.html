<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon Missadventures</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        body {
           background-image: url('images/Dungeon.jpg');
           background-size: cover;
           background-repeat: no-repeat;
           background-attachment: fixed;
           background-color: #f8f9fa;
       }
       .main-title {
           margin: 20px 0;
           text-align: center;
           font-size: 2.5rem;
           font-weight: bold;
           color: #ffffff; /* Color claro para el texto */
       }
       .card {
           margin-bottom: 20px;
       }
       .register-link {
           cursor: pointer;
           color: blue;
           text-decoration: underline;
       }
    </style>
</head>
<body>
<!-- Login Page -->
<div id="loginPage" class="container mt-5">
    <div class="main-title">Dungeon Missadventures</div>
    <div class="card">
        <div class="card-header">
            <h2>Login</h2>
        </div>
        <div class="card-body">
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario:</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
            <div class="mt-3">
                ¿No estás registrado?
                <span class="register-link" data-toggle="modal" data-target="#registroModal">Regístrate aquí</span>
            </div>
            <div id="loginMessage" class="mt-3"></div>
        </div>
    </div>
</div>

<!-- Registro Modal -->
<div class="modal fade" id="registroModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registro de Usuario</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="form-group">
                        <label for="regEmail">Email:</label>
                        <input type="email" class="form-control" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="regUsername">Username:</label>
                        <input type="text" class="form-control" id="regUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="regPassword">Password:</label>
                        <input type="password" class="form-control" id="regPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="regConfirmPassword">Confirmar Password:</label>
                        <input type="password" class="form-control" id="regConfirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmRegisterBtn">Registrar</button>
            </div>
            <div id="registerMessage" class="text-center"></div>
        </div>
    </div>
</div>

<!-- Página Principal -->
<div id="mainPage" style="display:none;">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Dungeons Missadventures</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="#" id="productListLink">Tienda</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="inventoryLink">Inventario</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="settingsLink">Ajustes</a>
                </li>
            </ul>
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#" id="logoutLink">Cerrar Sesión</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4" id="mainContent">
        <!-- Contenido principal se cargará aquí -->
    </div>
</div>

<!-- Crear el contenido de la pestaña de ajustes -->
<div id="settingsPage" class="container mt-4" style="display:none;">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h2>Ajustes</h2>
        </div>
        <div class="card-body">
            <p><strong>Usuario:</strong> <span id="settingsUsername"></span></p>
            <p><strong>Email:</strong> <span id="settingsEmail"></span></p>
            <button class="btn btn-primary" id="changeEmailBtn">Cambiar Email</button>
            <button class="btn btn-primary" id="changePasswordBtn">Cambiar Contraseña</button>
            <button class="btn btn-danger" id="deleteAccountBtn">Eliminar Cuenta</button>
        </div>
    </div>
</div>
<!-- Modal para cambiar el correo -->
<div class="modal fade" id="changeEmailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cambiar Email</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="changeEmailForm">
                    <div class="form-group">
                        <label for="currentUsername">Usuario:</label>
                        <input type="text" class="form-control" id="currentUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="currentPasswordEmail">Contraseña Actual:</label>
                        <input type="password" class="form-control" id="currentPasswordEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="newEmail">Nuevo Email:</label>
                        <input type="email" class="form-control" id="newEmail" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmChangeEmailBtn">Cambiar Email</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para eliminar la cuenta -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eliminar Cuenta</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="deleteAccountForm">
                    <div class="form-group">
                        <label for="deletePassword1">Contraseña Actual:</label>
                        <input type="password" class="form-control" id="deletePassword1" required>
                    </div>
                    <div class="form-group">
                        <label for="deletePassword2">Confirmar Contraseña Actual:</label>
                        <input type="password" class="form-control" id="deletePassword2" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteAccountBtn">Eliminar Cuenta</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para cambiar la contraseña -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cambiar Contraseña</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label for="currentPasswordPass">Contraseña Actual:</label>
                        <input type="password" class="form-control" id="currentPasswordPass" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Nueva Contraseña:</label>
                        <input type="password" class="form-control" id="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirmar Nueva Contraseña:</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmChangePasswordBtn">Cambiar Contraseña</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
    let loggedUsername = null;

    // Login form submission
    $('#loginForm').submit(function(event) {
        event.preventDefault();
        const username = $('#username').val();
        const password = $('#password').val();

        $.ajax({
            url: 'http://localhost:8080/game/user/login',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ username, password }),
            success: function(data) {
                loggedUsername = data.username;
                $('#loginPage').hide();
                $('#mainPage').show();
                $('#productListLink').click();
            },
            error: function() {
                $('#loginMessage').html('<div class="alert alert-danger">Error al iniciar sesión.</div>');
            }
        });
    });

    // Registro de usuario
    $('#confirmRegisterBtn').click(function() {
        const password = $('#regPassword').val();
        const confirmPassword = $('#regConfirmPassword').val();

        if (password !== confirmPassword) {
            $('#registerMessage').html('<div class="alert alert-danger">Las contraseñas no coinciden.</div>');
            return;
        }

        $.ajax({
            url: 'http://localhost:8080/game/user/',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                email: $('#regEmail').val(),
                username: $('#regUsername').val(),
                password: password
            }),
            success: function() {
                $('#registerMessage').html('<div class="alert alert-success">Registro exitoso.</div>');
                setTimeout(() => {
                    $('#registroModal').modal('hide');
                    $('#registerForm')[0].reset();
                }, 2000);
            },
            error: function() {
                $('#registerMessage').html('<div class="alert alert-danger">Error al registrarse.</div>');
            }
        });
    });

    // Lista de productos
    $('#productListLink').click(function(e) {
        e.preventDefault();
        $('#mainContent').show();
        $('#settingsPage').hide();

        $.ajax({
            url: 'http://localhost:8080/game/store',
            method: 'GET',
            success: function(data) {
                $('#mainContent').html(`
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h2>Lista de Productos</h2>
                        </div>
                        <div class="card-body">
                            <table class="table table-hover table-bordered">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Tipo</th>
                                        <th>Valor</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map(producto => `
                                        <tr>
                                            <td>${producto.id}</td>
                                            <td>${producto.type}</td>
                                            <td>${producto.value}</td>
                                            <td><button class="btn btn-success comprar-btn" data-id="${producto.id}">Comprar</button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `);

                // Comprar producto
                $('.comprar-btn').click(function() {
                    const itemId = $(this).data('id');

                    $.ajax({
                        url: `http://localhost:8080/game/user/${loggedUsername}/inventory/?item=${itemId}`,
                        method: 'PUT',
                        success: function() {
                            alert('Compra realizada con éxito.');
                            $('#inventoryLink').click();
                        },
                        error: function() {
                            alert('Error al realizar la compra.');
                        }
                    });
                });
            },
            error: function() {
                $('#mainContent').html('<div class="alert alert-danger">Error al cargar los productos.</div>');
            }
        });
    });

    // Inventario
    $('#inventoryLink').click(function(e) {
        e.preventDefault();
        $('#mainContent').show();
        $('#settingsPage').hide();

        if (!loggedUsername) {
            alert("El usuario no está logueado correctamente.");
            return;
        }

        $.ajax({
            url: `http://localhost:8080/game/user/${loggedUsername}/inventory`,
            method: 'GET',
            success: function(data) {
                if (!Array.isArray(data)) {
                    console.error("El inventario no es un array:", data);
                    $('#mainContent').html('<div class="alert alert-danger">Error en el formato de los datos del inventario.</div>');
                    return;
                }

                console.log("Inventario recibido:", data);

                let content = `
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h2>Inventario</h2>
                        </div>
                        <div class="card-body">
                            ${data.length ? `<table class="table table-hover table-bordered">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Usuario</th>
                                        <th>Item</th>
                                        <th>Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map(item => `
                                        <tr>
                                            <td>${item.id}</td>
                                            <td>${item.user}</td>
                                            <td>${item.item}</td>
                                            <td>${item.quantity}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>` : '<p>No tienes items en tu inventario.</p>'}
                        </div>
                    </div>
                `;
                $('#mainContent').html(content);
            },
            error: function(xhr, status, error) {
                console.error("Error al cargar el inventario:", error);
                $('#mainContent').html('<div class="alert alert-danger">Error al cargar el inventario.</div>');
            }
        });
    });

    // Mostrar la página de ajustes
    $('#settingsLink').click(function(e) {
        e.preventDefault();
        $('#mainContent').hide();
        $('#settingsPage').show();
        $('#settingsUsername').text(loggedUsername);

        // Obtener el correo del usuario logueado
        $.ajax({
            url: `http://localhost:8080/game/user/${loggedUsername}`,
            method: 'GET',
            success: function(data) {
                $('#settingsEmail').text(data.email);
            },
            error: function() {
                alert('Error al obtener los datos del usuario.');
            }
        });
    });

    // Cambiar el correo del usuario
    $('#changeEmailBtn').click(function() {
        $('#changeEmailModal').modal('show');
    });

    $('#confirmChangeEmailBtn').click(function() {
        const currentUsername = $('#currentUsername').val();
        const currentPassword = $('#currentPasswordEmail').val();
        const newEmail = $('#newEmail').val();
        if (currentUsername && currentPassword && newEmail) {
            $.ajax({
                url: `http://localhost:8080/game/user/${loggedUsername}?chgemail=true&newemail=${encodeURIComponent(newEmail)}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ username: currentUsername, password: currentPassword, email: newEmail }),
                success: function() {
                    alert('Correo actualizado con éxito.');
                    $('#settingsEmail').text(newEmail);
                    $('#changeEmailModal').modal('hide');
                },
                error: function() {
                    alert('Error al actualizar el correo.');
                }
            });
        }
    });

    // Cambiar la contraseña del usuario
    $('#changePasswordBtn').click(function() {
        $('#changePasswordModal').modal('show');
    });

    $('#confirmChangePasswordBtn').click(function() {
        const currentPassword = $('#currentPasswordPass').val();
        const newPassword = $('#newPassword').val();
        const confirmPassword = $('#confirmPassword').val();
        if (currentPassword && newPassword && confirmPassword) {
            if (newPassword === confirmPassword) {
                $.ajax({
                    url: `http://localhost:8080/game/user/${loggedUsername}?chgpass=true&newpass=${encodeURIComponent(newPassword)}`,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ username: loggedUsername, password: currentPassword }),
                    success: function() {
                        alert('Contraseña actualizada con éxito.');
                        $('#changePasswordModal').modal('hide');
                    },
                    error: function() {
                        alert('Error al actualizar la contraseña.');
                    }
                });
            } else {
                alert('Las contraseñas no coinciden.');
            }
        }
    });

    // Eliminar la cuenta del usuario
    $('#deleteAccountBtn').click(function() {
        $('#deleteAccountModal').modal('show');
    });

    $('#confirmDeleteAccountBtn').click(function() {
        const password1 = $('#deletePassword1').val();
        const password2 = $('#deletePassword2').val();

        if (password1 && password2) {
            if (password1 === password2) {
                if (confirm('¿Estás seguro de que deseas eliminar tu cuenta? Esta acción no se puede deshacer.')) {
                    $.ajax({
                        url: `http://localhost:8080/game/user/${loggedUsername}`,
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ username: loggedUsername, password: password1 }),
                        success: function() {
                            alert('Cuenta eliminada con éxito.');
                            loggedUsername = null;
                            $('#settingsPage').hide();
                            $('#loginPage').show();
                            $('#deleteAccountModal').modal('hide');
                        },
                        error: function() {
                            alert('Error al eliminar la cuenta.');
                        }
                    });
                }
            } else {
                alert('Las contraseñas no coinciden.');
            }
        }
    });

    // Cerrar sesión
    $('#logoutLink').click(function() {
        loggedUsername = null;
        $('#mainPage').hide();
        $('#loginPage').show();
        $('#loginForm')[0].reset();
        $('#settingsPage').hide(); // Ocultar la pestaña de ajustes
    });
});
</script>
</body>
</html>